# Security Audit: google-mcp-server

**Date:** February 19, 2026 (UTC+10)
**Auditor:** Claude Opus 4.6 (automated)
**Repo:** [beau-labrys/google-mcp-server](https://github.com/beau-labrys/google-mcp-server)
**Language:** Go | **Type:** MCP server for Google APIs

---

## Secrets Safety: CLEAN

- No hardcoded API keys, tokens, passwords, or private keys
- No committed `.env`, `token.json`, `credentials.json`, `*.pem`, or `*.key` files
- `.gitignore` properly excludes sensitive files
- CI runs Gosec and Trivy security scanners

---

## Findings Summary

| Severity | Count |
|----------|-------|
| CRITICAL | 0 |
| HIGH | 1 |
| MEDIUM | 2 |
| LOW | 3 |
| **Total** | **6** |

---

## HIGH

### 1. Static OAuth State in `accounts_add` Handler
- **File:** `accounts/handler.go:266`
- **Issue:** `handleAccountsAdd` generates an OAuth URL with a hardcoded static string `"state"` as the CSRF parameter:
  ```go
  authURL := config.AuthCodeURL("state", oauth2.AccessTypeOffline)
  ```
  This bypasses the cryptographically random state that the `OAuthCallbackServer` generates internally. The resulting URL has no CSRF protection and would also fail callback validation (state mismatch).
- **Fix:** Replace with:
  ```go
  authURL := callbackServer.GetAuthURL()
  ```

---

## MEDIUM

### 2. Reflected XSS in OAuth Error Callback
- **File:** `auth/oauth_server.go:137-157`
- **Issue:** The OAuth callback reads the `error` query parameter and reflects it directly into HTML without escaping:
  ```go
  errMsg := r.URL.Query().Get("error")
  fmt.Fprintf(w, `... <p>Error: %s</p> ...`, errMsg)
  ```
  An attacker could craft a localhost URL injecting JavaScript. Attack surface is limited (ephemeral localhost server) but still exploitable.
- **Fix:** Use `html.EscapeString(errMsg)` before rendering.

### 3. Drive Query Injection via `parentID`
- **File:** `drive/client.go:58`
- **Issue:** `ListFiles` inserts `parentID` directly into a Drive API query without escaping:
  ```go
  parentQuery := fmt.Sprintf("'%s' in parents", parentID)
  ```
  A crafted `parentID` could manipulate query logic. Impact is limited (queries user's own Drive) but violates defense-in-depth.
- **Fix:** Apply `escapeDriveQuery()` to `parentID`.

---

## LOW

### 4. Multi-Account Token Files Not Permission-Checked
- **File:** `auth/account_manager.go:99-117`
- **Issue:** `loadAccounts` reads token files without verifying `0600` permissions, unlike the single-account path in `oauth.go` which correctly enforces this check.
- **Fix:** Add permission check before reading each token file, consistent with `oauth.go`.

### 5. `config.json` Not Gitignored
- **File:** `.gitignore`
- **Issue:** `config.json` and `config.local.json` are not in `.gitignore`. The config structure contains `client_id` and `client_secret` fields. No config file is currently committed, but this is a preventive risk.
- **Fix:** Add `config.json` and `config.local.json` to `.gitignore`.

### 6. Broad Default OAuth Scopes
- **File:** `auth/oauth.go:110-122`
- **Issue:** `DefaultScopes()` requests full access to all Google services at once rather than incrementally. Increases blast radius if a token is compromised.
- **Fix:** Consider requesting only scopes for enabled services.

---

## Verified as Properly Secured

1. CSRF state validation uses `crypto/rand` in `oauth.go` and `oauth_server.go`
2. OAuth callback server binds to `localhost` only (not `0.0.0.0`)
3. All JSON-RPC handlers guard against nil `req.Params`
4. Bounded stdin via `bufio.Scanner` with 10MB max buffer
5. Token file permissions (`0600`) enforced on save and load (single-account path)
6. Token revocation sends token in POST body, not URL query
7. Both access and refresh tokens revoked on logout
8. Drive query escaping via `escapeDriveQuery()` for search operations
9. Download/upload size limits (100MB/50MB) with `io.LimitReader`
10. ID validation helper rejects empty and oversized IDs
11. Generic error messages returned to clients; full errors logged to stderr
12. HTTP server timeouts set on OAuth callback server
13. O(1) tool lookup via `toolMap`
14. No `exec`, `eval`, `system`, or `unsafe` package usage

---

*Generated by security review agent on February 19, 2026*
